<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media26 Iptv Web App</title>
    <style>
        /* --- Premium Light Theme --- */
        :root {
            --bg-color: #f8f9fa;
            --card-color: #ffffff;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-color: #007bff;
            --success-color-fg: #198754;
            --success-color-bg: rgba(25, 135, 84, 0.1);
            --danger-color-fg: #dc3545;
            --danger-color-bg: rgba(220, 53, 69, 0.1);
            --warning-color-fg: #ffc107;
            --warning-color-bg: rgba(255, 193, 7, 0.15);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        /* --- Layout --- */
        .container {
            display: flex;
            width: 100%;
        }

        aside {
            width: 320px;
            flex-shrink: 0;
            background-color: #e9ecef;
            padding: 25px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        main {
            flex-grow: 1;
            padding: 25px 40px;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        h1 { font-size: 1.8em; margin-bottom: 30px; }
        h2 { font-size: 1.5em; margin-bottom: 20px; }
        h3 { font-size: 1.1em; margin-top: 0; margin-bottom: 15px; padding-bottom: 8px; }

        /* --- Cards --- */
        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        /* --- Financial & Summary Panel --- */
        .summary-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-item:last-child { border-bottom: none; margin-bottom: 0; }
        .summary-item span:first-child { color: var(--text-secondary); }
        .summary-item span:last-child { font-weight: 600; font-size: 1.1em; }
        .net-profit { color: var(--success-color-fg); }
        .total-expenses { color: var(--danger-color-fg); }
        .summary-filter { display: flex; gap: 10px; margin-bottom: 20px; }

        /* --- Forms & Search --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { font-size: 0.9em; margin-bottom: 8px; color: var(--text-secondary); }
        input, select, textarea {
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .search-bar { margin-bottom: 20px; }
        textarea { resize: vertical; min-height: 80px; }
        .btn {
            padding: 12px 20px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-primary { background-color: var(--accent-color); color: #fff; grid-column: 1 / -1; margin-top: 10px; }
        .btn-primary:hover { background-color: #0069d9; }
        .btn-secondary { background-color: var(--success-color-fg); color: #fff; }
        .btn-secondary:hover { background-color: #157347; }

        /* --- Customer Table --- */
        .table-container { width: 100%; overflow-x: auto; border: 1px solid var(--border-color); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; }
        th, td {
            padding: 8px;
            font-size: 0.95em;
            vertical-align: middle;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        thead th {
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            padding: 15px 8px;
        }
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tbody tr:hover { background-color: #e9ecef; }

        /* Styles for editable fields in table */
        tbody input, tbody select {
            background-color: transparent;
            border: 1px solid transparent;
            padding: 7px;
            width: 100%;
            box-sizing: border-box;
        }
        tbody input:focus, tbody select:focus {
            background-color: #fff;
            border-color: var(--accent-color);
        }
        
        .btn-delete {
            background-color: var(--danger-color-fg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-delete:hover { background-color: #c82333; }
        
        /* --- Row Highlighting Classes --- */
        .row-expiring { background-color: var(--warning-color-bg) !important; }
        .row-expired { background-color: var(--danger-color-bg) !important; }
    </style>
</head>
<body>

    <div class="container">
        <!-- SIDEBAR -->
        <aside>
            <div class="card">
                <h3>Summary Report</h3>
                <div class="summary-filter">
                    <select id="summaryMonth"></select>
                    <select id="summaryYear"></select>
                </div>
                <div class="summary-item">
                    <span>Customers This Month</span>
                    <span id="customerCount">0</span>
                </div>
                <div class="summary-item">
                    <span>Total Income</span>
                    <span id="totalIncome">$0.00</span>
                </div>
                <div class="summary-item">
                    <span>Total Expenses</span>
                    <span id="totalExpenses" class="total-expenses">-$0.00</span>
                </div>
                 <div class="summary-item">
                    <span>Net Profit</span>
                    <span id="netProfit" class="net-profit">$0.00</span>
                </div>
            </div>
            <div class="card">
                <h3>Add Expense</h3>
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="expenseType">Purchasing Credits</label>
                        <select id="expenseType" name="expenseType" required>
                            <option value="Smart4k">Smart4k</option>
                            <option value="Magic">Magic</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="expenseAmount">Amount ($)</label>
                        <input type="number" id="expenseAmount" name="expenseAmount" min="0" step="0.01" required placeholder="Enter amount">
                    </div>
                    <button type="submit" class="btn btn-secondary" style="margin-top: 20px;">Add Expense</button>
                </form>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main>
            <h1>Media26 Iptv Web App</h1>
            <div class="card">
                <h2>Create New Customer</h2>
                <form id="newCustomerForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="customerName">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="login">Login</label>
                            <input type="text" id="login" name="login" readonly>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="text" id="password" name="password" readonly>
                        </div>
                        <div class="form-group">
                            <label for="appOrBox">App or Box</label>
                            <select id="appOrBox" name="appOrBox" required>
                                <optgroup label="App">
                                    <option>SmartSTB</option>
                                    <option>Stb Emu</option>
                                </optgroup>
                                <optgroup label="Box">
                                    <option>TVIP</option>
                                    <option>MAG</option>
                                    <option>Other</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="macAddress">MAC Address (Optional)</label>
                            <input type="text" id="macAddress" name="macAddress" placeholder="e.g., 00:1A:79:XX:XX:XX">
                        </div>
                        <div class="form-group">
                            <label for="subscriptionType">Subscription</label>
                            <select id="subscriptionType" name="subscriptionType" required>
                                <option value="6">6 Months</option>
                                <option value="1">1 Month</option>
                                <option value="3">3 Months</option>
                                <option value="12">12 Months</option>
                                <option value="trial">Trial (7 days)</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="subscriptionDate">Subscription Date</label>
                            <input type="date" id="subscriptionDate" name="subscriptionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="subscriptionEndingDate">Subscription Ending Date</label>
                            <input type="text" id="subscriptionEndingDate" name="subscriptionEndingDate" readonly>
                        </div>
                         <div class="form-group">
                            <label for="paymentStatus">Payment Status</label>
                            <select id="paymentStatus" name="paymentStatus" required>
                                <option value="Paid">Paid</option>
                                <option value="Unpaid">Unpaid</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentAmount">Payment Amount ($)</label>
                            <input type="number" id="paymentAmount" name="paymentAmount" min="0" step="0.01" value="60.00" required>
                        </div>
                        <div class="form-group full-width">
                            <label for="specialNote">Special Note</label>
                            <textarea id="specialNote" name="specialNote" placeholder="e.g., Customer wants sports package, renewal reminder needed..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add New Customer</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>Customer List</h2>
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by name, app, or login...">
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>App/Box</th>
                                <th>Login</th>
                                <th>Ends On</th>
                                <th>Status</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // ===================================================================================
        // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ===================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DOM ELEMENT SELECTORS ---
        const customerForm = document.getElementById('newCustomerForm');
        const expenseForm = document.getElementById('expenseForm');
        const customerNameInput = document.getElementById('customerName');
        const loginInput = document.getElementById('login');
        const passwordInput = document.getElementById('password');
        const customerTableBody = document.getElementById('customerTableBody');
        const subscriptionType = document.getElementById('subscriptionType');
        const subscriptionDate = document.getElementById('subscriptionDate');
        const subscriptionEndingDate = document.getElementById('subscriptionEndingDate');
        const customerCountEl = document.getElementById('customerCount');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netProfitEl = document.getElementById('netProfit');
        const summaryMonthEl = document.getElementById('summaryMonth');
        const summaryYearEl = document.getElementById('summaryYear');
        const searchInput = document.getElementById('searchInput');
        
        let localCustomers = [];
        let localExpenses = [];
        let userId = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                loadData(userId);
            } else {
                // User is signed out. Sign in anonymously.
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        // --- DATA LOADING ---
        function loadData(uid) {
            const customerCol = collection(db, `users/${uid}/customers`);
            onSnapshot(customerCol, (snapshot) => {
                localCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
                updateSummary();
            });

            const expenseCol = collection(db, `users/${uid}/expenses`);
            onSnapshot(expenseCol, (snapshot) => {
                localExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSummary();
            });
        }

        // --- UTILITY FUNCTIONS ---
        function formatDate(date) {
            const d = new Date(date);
            d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const calculateEndDate = () => {
            const startDate = new Date(subscriptionDate.value);
            const type = subscriptionType.value;
            if (!startDate.getTime()) return;
            if (type === 'trial') {
                startDate.setDate(startDate.getDate() + 7);
            } else {
                startDate.setMonth(startDate.getMonth() + parseInt(type, 10));
            }
            subscriptionEndingDate.value = formatDate(startDate);
        };
        
        const formatCurrency = (amount) => {
            return (amount || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        };

        const generateCredentials = (fullName) => {
            if (!fullName) {
                return { login: '', password: '' };
            }
            const names = fullName.trim().split(' ').filter(n => n);
            const firstName = (names[0] || '').toUpperCase();
            const lastName = (names.length > 1 ? names[names.length - 1] : '').toUpperCase();
            const login = 'M26' + firstName.substring(0, 3);
            let password;
            if (lastName) {
                password = 'M26' + firstName.substring(0, 2) + lastName.substring(0, 2);
            } else {
                password = 'M26' + firstName.substring(0, 2) + firstName.slice(-2);
            }
            return { login, password };
        };

        // --- RENDER/UPDATE FUNCTIONS ---
        const updateSummary = () => {
            const selectedMonth = summaryMonthEl.value;
            const selectedYear = summaryYearEl.value;

            const totalIncomeVal = localCustomers
                .filter(c => c.status === 'Paid')
                .reduce((sum, c) => sum + (c.amount || 0), 0);

            const totalExpensesVal = localExpenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            const netProfitVal = totalIncomeVal - totalExpensesVal;

            let customersForPeriod = localCustomers;
            if (selectedMonth !== 'all') {
                customersForPeriod = localCustomers.filter(c => {
                    const subDate = new Date(c.subDate);
                    return subDate.getFullYear() == selectedYear && subDate.getMonth() == selectedMonth;
                });
            }
            
            customerCountEl.textContent = customersForPeriod.length;
            totalIncomeEl.textContent = formatCurrency(totalIncomeVal);
            totalExpensesEl.textContent = `-${formatCurrency(totalExpensesVal)}`;
            netProfitEl.textContent = formatCurrency(netProfitVal);
            netProfitEl.classList.toggle('net-profit', netProfitVal >= 0);
            netProfitEl.classList.toggle('total-expenses', netProfitVal < 0);
        };

        const renderTable = () => {
            const searchTerm = searchInput.value.toLowerCase();
            let customersToRender = localCustomers;

            if (searchTerm) {
                customersToRender = localCustomers.filter(customer => {
                    const name = (customer.name || '').toLowerCase();
                    const app = (customer.app || '').toLowerCase();
                    const login = (customer.login || '').toLowerCase();
                    return name.includes(searchTerm) || app.includes(searchTerm) || login.includes(searchTerm);
                });
            }

            customerTableBody.innerHTML = '';
            if (customersToRender.length === 0) {
                customerTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color: var(--text-secondary);">No customers found.</td></tr>`;
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            customersToRender.forEach((customer) => {
                const row = document.createElement('tr');
                row.dataset.id = customer.id;
                const endDate = new Date(customer.endDate);
                endDate.setMinutes(endDate.getMinutes() + endDate.getTimezoneOffset());
                const timeDiff = endDate.getTime() - today.getTime();
                const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (dayDiff < 0) {
                    row.classList.add('row-expired');
                } else if (dayDiff <= 7) {
                    row.classList.add('row-expiring');
                }
                
                row.innerHTML = `
                    <td><input type="text" value="${customer.name || ''}" data-prop="name"></td>
                    <td>
                        <select data-prop="app">
                            <optgroup label="App">
                                <option ${customer.app === 'SmartSTB' ? 'selected' : ''}>SmartSTB</option>
                                <option ${customer.app === 'Stb Emu' ? 'selected' : ''}>Stb Emu</option>
                            </optgroup>
                            <optgroup label="Box">
                                <option ${customer.app === 'TVIP' ? 'selected' : ''}>TVIP</option>
                                <option ${customer.app === 'MAG' ? 'selected' : ''}>MAG</option>
                                <option ${customer.app === 'Other' ? 'selected' : ''}>Other</option>
                            </optgroup>
                        </select>
                    </td>
                    <td><input type="text" value="${customer.login || ''}" data-prop="login"></td>
                    <td><input type="date" value="${customer.endDate || ''}" data-prop="endDate"></td>
                    <td>
                        <select data-prop="status">
                            <option value="Paid" ${customer.status === 'Paid' ? 'selected' : ''}>Paid</option>
                            <option value="Unpaid" ${customer.status === 'Unpaid' ? 'selected' : ''}>Unpaid</option>
                        </select>
                    </td>
                    <td><input type="text" value="${customer.note || ''}" data-prop="note"></td>
                    <td><button class="btn-delete">Delete</button></td>
                `;
                customerTableBody.appendChild(row);
            });
        };

        // --- EVENT HANDLERS ---
        async function handleTableEdit(e) {
            const target = e.target;
            if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
                const row = target.closest('tr');
                const docId = row.dataset.id;
                const prop = target.dataset.prop;
                const value = target.value;

                const docRef = doc(db, `users/${userId}/customers`, docId);
                try {
                    await updateDoc(docRef, { [prop]: value });
                } catch (error) {
                    console.error("Error updating document: ", error);
                }
            }
        };

        async function handleTableClick(e) {
            if (e.target.classList.contains('btn-delete')) {
                const row = e.target.closest('tr');
                const docId = row.dataset.id;
                const customerName = row.querySelector('input[data-prop="name"]').value;

                if (confirm(`Are you sure you want to delete ${customerName}?`)) {
                    const docRef = doc(db, `users/${userId}/customers`, docId);
                    try {
                        await deleteDoc(docRef);
                    } catch (error) {
                        console.error("Error deleting document: ", error);
                    }
                }
            }
        };

        const handleNameInput = (e) => {
            const { login, password } = generateCredentials(e.target.value);
            loginInput.value = login;
            passwordInput.value = password;
        };

        async function handleAddCustomer(e) {
            e.preventDefault();
            if (!userId) {
                console.error("User not authenticated yet.");
                return;
            }
            const formData = new FormData(customerForm);
            const newCustomer = {
                name: formData.get('customerName'),
                app: formData.get('appOrBox'),
                login: loginInput.value,
                password: passwordInput.value,
                subDate: formData.get('subscriptionDate'),
                endDate: subscriptionEndingDate.value,
                status: formData.get('paymentStatus'),
                note: formData.get('specialNote'),
                amount: parseFloat(formData.get('paymentAmount')) || 0
            };
            
            try {
                const customerCol = collection(db, `users/${userId}/customers`);
                await addDoc(customerCol, newCustomer);
                customerForm.reset();
                initializeFormDefaults();
            } catch (error) {
                console.error("Error adding customer: ", error);
            }
        };

        async function handleAddExpense(e) {
            e.preventDefault();
            if (!userId) {
                console.error("User not authenticated yet.");
                return;
            }
            const amountInput = document.getElementById('expenseAmount');
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount <= 0) {
                amountInput.style.borderColor = 'var(--danger-color-fg)';
                return;
            }
            amountInput.style.borderColor = 'var(--border-color)';
            
            const newExpense = {
                date: formatDate(new Date()),
                amount: amount,
                description: document.getElementById('expenseType').value
            };

            try {
                const expenseCol = collection(db, `users/${userId}/expenses`);
                await addDoc(expenseCol, newExpense);
                expenseForm.reset();
            } catch (error) {
                console.error("Error adding expense: ", error);
            }
        };

        // --- INITIALIZATION ---
        const initializeFormDefaults = () => {
            subscriptionDate.value = formatDate(new Date());
            calculateEndDate();
            loginInput.value = '';
            passwordInput.value = '';
        };

        const populateDateFilters = () => {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            summaryMonthEl.innerHTML = `<option value="all">All Time</option>`;
            months.forEach((month, index) => {
                summaryMonthEl.innerHTML += `<option value="${index}">${month}</option>`;
            });

            summaryYearEl.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                summaryYearEl.innerHTML += `<option value="${i}">${i}</option>`;
            }

            summaryMonthEl.value = currentMonth;
            summaryYearEl.value = currentYear;
        };
        
        customerForm.addEventListener('submit', handleAddCustomer);
        expenseForm.addEventListener('submit', handleAddExpense);
        customerNameInput.addEventListener('input', handleNameInput);
        subscriptionDate.addEventListener('change', calculateEndDate);
        subscriptionType.addEventListener('change', calculateEndDate);
        summaryMonthEl.addEventListener('change', updateSummary);
        summaryYearEl.addEventListener('change', updateSummary);
        customerTableBody.addEventListener('change', handleTableEdit);
        customerTableBody.addEventListener('click', handleTableClick);
        searchInput.addEventListener('input', renderTable);

        populateDateFilters();
        initializeFormDefaults();
    </script>
</body>
</html>
