
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media26 IPTV Dashboard</title>
    <style>
        /* --- Professional Theme (Blue Accent) --- */
        :root {
            --bg-color: #f8f9fa;
            --card-color: #ffffff;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-color: #0d6efd; /* Professional Blue */
            --accent-hover: #0b5ed7;
            --danger-color: #dc3545;
            --danger-hover: #bb2d3b;
            --success-color: #198754;
            --warning-bg: #fff3cd;
            --expired-bg: #f8d7da;
            --expired-text: #842029;
            --font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
        }

        aside {
            width: 350px;
            flex-shrink: 0;
            background-color: #ffffff;
            padding: 30px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }
        
        main {
            flex-grow: 1;
            padding: 30px 40px;
            overflow-y: auto;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1, h2, h3 {
            color: var(--text-primary);
            margin: 0;
            font-weight: 600;
        }
        
        h1 { font-size: 1.8em; margin-bottom: 0; }
        h2 { font-size: 1.5em; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        h3 { font-size: 1.25em; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }

        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 0.375rem;
            margin-bottom: 10px;
        }
        .summary-item:last-of-type { margin-bottom: 0; }
        .summary-item span:first-child { font-size: 0.8em; }
        .summary-item span:last-child { font-weight: 700; font-size: 1em; }

        #activeUsers { color: #0a58ca; }
        #expiredUsers { color: #dc3545; }
        #customerCount { color: #6f42c1; }
        #totalIncome { color: #198754; }
        #totalExpenses { color: #dc3545; }
        #netProfit.net-profit { color: #198754; }
        #netProfit.total-expenses { color: #dc3545; }
        
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        label { font-weight: 500; font-size: 0.9em; color: var(--text-secondary); }
        
        input, select, textarea {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        input.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25);
        }
        input[readonly] { background-color: #e9ecef; }

        .btn {
            padding: 8px 12px;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--accent-color); color: #fff; width: 100%; grid-column: 1 / -1; margin-top: 10px; padding: 12px 20px; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }

        #undo-btn {
            background-color: #6c757d;
            color: #fff;
        }
        #undo-btn:disabled {
            background-color: #ced4da;
            cursor: not-allowed;
        }
        #undo-btn:hover:not(:disabled) {
            background-color: #5c636a;
        }
        
        .actions-cell { display: flex; gap: 8px; }
        .btn-edit { background-color: #cfe2ff; color: #0a58ca; }
        .btn-edit:hover { background-color: #b9d3fa; }
        .btn-save { background-color: #d1e7dd; color: var(--success-color); }
        .btn-save:hover { background-color: #badbcc; }
        
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 0.5rem; 
            background-color: #fff;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td {
            padding: 12px 15px;
            font-size: 0.9em;
            vertical-align: middle;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        th:last-child, td:last-child {
            border-right: none;
        }
        tbody tr:last-child > td { border-bottom: none; }
        
        thead th {
            font-size: 0.8em;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            position: relative;
        }
        th.sortable { cursor: pointer; }
        th.sortable:hover { background-color: #f1f3f5; }
        th.sortable::after { content: ' \\2195'; font-size: 1.2em; color: #ced4da; position: absolute; right: 10px; }
        th.sort-asc::after { content: ' \\25B2'; color: var(--accent-color); }
        th.sort-desc::after { content: ' \\25BC'; color: var(--accent-color); }
        
        tbody tr:hover { background-color: #f8f9fa; }
        
        .row-expiring { background-color: var(--warning-bg) !important; }
        .row-expired { 
            background-color: var(--expired-bg) !important;
            color: var(--expired-text) !important;
        }
        
        .btn-delete { background-color: #f8d7da; color: var(--danger-color); }
        .btn-delete:hover { background-color: var(--danger-color); color: #fff; }

        .modal-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        #delayed-list li {
            padding: 5px 0;
        }

        @media (max-width: 992px) {
            .container { flex-direction: column; }
            aside { width: 100%; box-sizing: border-box; border-right: none; border-bottom: 1px solid var(--border-color); }
            main { width: 100%; box-sizing: border-box; padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <aside>
            <div class="card">
                <h3>Summary Report</h3>
                <div class="summary-filter"><select id="summaryMonth"></select><select id="summaryYear"></select></div>
                <div class="summary-item" style="background-color: #e0e7ff;"><span>Active Users</span><span id="activeUsers">0</span></div>
                <div class="summary-item" style="background-color: #fee2e2;"><span>Expired Users</span><span id="expiredUsers">0</span></div>
                <div class="summary-item" style="background-color: #f3e8ff;"><span>Customers This Month</span><span id="customerCount">0</span></div>
                <div class="summary-item" style="background-color: #dcfce7;"><span>Income This Month</span><span id="totalIncome">$0.00</span></div>
                <div class="summary-item" style="background-color: #ffe4e6;"><span>Expenses This Month</span><span id="totalExpenses">-$0.00</span></div>
                <div class="summary-item" style="background-color: #d1fae5;"><span>Net Profit This Month</span><span id="netProfit">$0.00</span></div>
            </div>
            <div class="card">
                <h3>Expense Management</h3>
                <button id="add-expense-btn" class="btn" style="background-color: var(--success-color); color: #fff; width: 100%; padding: 12px; margin-bottom: 15px;">Add New Expense</button>
                <div class="table-container" style="max-height: 280px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Description</th><th>Amount</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>
        </aside>

        <main>
            <div class="main-header">
                <h1>IPTV Dashboard</h1>
                <button class="btn" id="undo-btn" disabled>Undo Last Action</button>
            </div>
            
            <div id="notification-bar" class="notification-bar" style="display: none;"></div>

            <div class="card">
                <h2>Create New Customer</h2>
                <form id="newCustomerForm">
                    <div class="form-grid">
                        <div class="form-group"><label for="customerName">Customer Name</label><input type="text" id="customerName" name="customerName" required></div>
                        <div class="form-group"><label for="phone">Phone Number</label><input type="tel" id="phone" name="phone"></div>
                        <div class="form-group"><label for="login">Login</label><input type="text" id="login" name="login" readonly></div>
                        <div class="form-group"><label for="password">Password</label><input type="text" id="password" name="password" readonly></div>
                        <div class="form-group"><label for="macAddress">MAC Address (Optional)</label><input type="text" id="macAddress" name="macAddress"></div>
                        <div class="form-group">
                            <label for="subscriptionType">Subscription</label>
                            <select id="subscriptionType" name="subscriptionType" required>
                                <option value="1">1 Month</option><option value="2">2 Months</option><option value="3">3 Months</option><option value="4">4 Months</option><option value="5">5 Months</option>
                                <option value="6" selected>6 Months</option><option value="7">7 Months</option><option value="8">8 Months</option><option value="9">9 Months</option><option value="10">10 Months</option>
                                <option value="11">11 Months</option><option value="12">12 Months</option><option value="trial">Trial (7 days)</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="subscriptionDate">Subscription Date</label><input type="date" id="subscriptionDate" name="subscriptionDate" required></div>
                        <div class="form-group"><label for="subscriptionEndingDate">Subscription Ending Date</label><input type="text" id="subscriptionEndingDate" name="subscriptionEndingDate" readonly></div>
                        <div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" name="paymentStatus" required><option>Paid</option><option>Unpaid</option></select></div>
                        <div class="form-group"><label for="paymentAmount">Payment Amount ($)</label><input type="number" id="paymentAmount" name="paymentAmount" min="0" step="0.01" required></div>
                        <div class="form-group full-width"><label for="specialNote">Special Note</label><textarea id="specialNote" name="specialNote"></textarea></div>
                        <button type="submit" class="btn btn-primary">Add New Customer</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>Customer List</h2>
                <div class="search-bar" style="margin-bottom: 20px;"><input type="text" id="searchInput" placeholder="Search by name or login..."></div>
                <div class="table-container">
                    <table id="customer-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Customer Name</th>
                                <th class="sortable" data-sort="phone">Phone</th>
                                <th class="sortable" data-sort="login">Login</th>
                                <th class="sortable" data-sort="subDate">Created On</th>
                                <th class="sortable" data-sort="endDate">Ends On</th>
                                <th class="sortable" data-sort="daysLeft">Days Left</th>
                                <th>Status</th>
                                <th>Note</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="delayed-payment-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Delayed Payments Reminder</h3><button id="modal-close-btn" class="modal-close">&times;</button></div>
            <ul id="delayed-list"></ul>
        </div>
    </div>

    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Add New Expense</h3><button id="expense-modal-close-btn" class="modal-close">&times;</button></div>
            <form id="expenseForm" class="form-group">
                <label for="expenseType">Purchasing Credits</label><select id="expenseType" name="expenseType" required><option>Smart4k</option><option>Magic</option></select>
                <label for="expenseAmount">Amount ($)</label><input type="number" id="expenseAmount" name="expenseAmount" min="0" step="0.01" required>
                <label for="expenseDate">Expense Date</label><input type="date" id="expenseDate" name="expenseDate" required>
                <button type="submit" class="btn" style="padding: 12px 20px; margin-top: 10px; background-color: var(--success-color); color: #fff;">Add Expense</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const customerForm = document.getElementById('newCustomerForm');
        const expenseForm = document.getElementById('expenseForm');
        const customerNameInput = document.getElementById('customerName');
        const loginInput = document.getElementById('login');
        const passwordInput = document.getElementById('password');
        const customerTableBody = document.getElementById('customerTableBody');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const subscriptionType = document.getElementById('subscriptionType');
        const subscriptionDate = document.getElementById('subscriptionDate');
        const subscriptionEndingDate = document.getElementById('subscriptionEndingDate');
        const expenseDateInput = document.getElementById('expenseDate');
        const paymentAmountInput = document.getElementById('paymentAmount');
        const customerCountEl = document.getElementById('customerCount');
        const activeUsersEl = document.getElementById('activeUsers');
        const expiredUsersEl = document.getElementById('expiredUsers');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netProfitEl = document.getElementById('netProfit');
        const summaryMonthEl = document.getElementById('summaryMonth');
        const summaryYearEl = document.getElementById('summaryYear');
        const searchInput = document.getElementById('searchInput');
        const undoBtn = document.getElementById('undo-btn');
        const notificationBar = document.getElementById('notification-bar');
        const delayedPaymentModal = document.getElementById('delayed-payment-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const delayedList = document.getElementById('delayed-list');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const expenseModal = document.getElementById('expense-modal');
        const expenseModalCloseBtn = document.getElementById('expense-modal-close-btn');
        
        let localCustomers = [];
        let localExpenses = [];
        let userId = null;
        let db; 
        let sortConfig = { key: 'subDate', direction: 'desc' };
        let lastAction = null;

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const formatDisplayDate = (dateString) => {
            if (!dateString) return '';
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const date = new Date(dateString);
            date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
            const day = String(date.getDate()).padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const formatCurrency = (amount) => (amount || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

        const calculateEndDate = () => {
            const startDate = new Date(subscriptionDate.value);
            const type = subscriptionType.value;
            if (!startDate.getTime() || !subscriptionDate.value) return;
            if (type === 'trial') {
                startDate.setDate(startDate.getDate() + 7);
            } else {
                startDate.setMonth(startDate.getMonth() + parseInt(type, 10));
            }
            subscriptionEndingDate.value = formatDate(startDate);
        };
        
        const updatePaymentAmount = () => {
            const subscriptionValue = subscriptionType.value;
            let amount = 0;
            if (subscriptionValue === 'trial') { amount = 0; } 
            else { const months = parseInt(subscriptionValue, 10); amount = months * 10; }
            paymentAmountInput.value = amount.toFixed(2);
        };

        const generateCredentials = (fullName) => {
            if (!fullName) { return { login: '', password: '' }; }
            const names = fullName.trim().split(' ').filter(n => n);
            const firstName = (names[0] || '').toUpperCase();
            const lastName = (names.length > 1 ? names[names.length - 1] : '').toUpperCase();
            const login = 'M26' + firstName.substring(0, 3);
            let password = lastName ? 'M26' + firstName.substring(0, 2) + lastName.substring(0, 2) : 'M26' + firstName.substring(0, 2) + firstName.slice(-2);
            return { login, password };
        };
        
        const initializeFormDefaults = () => {
            const today = new Date();
            subscriptionDate.value = formatDate(today);
            expenseDateInput.value = formatDate(today);
            calculateEndDate();
            updatePaymentAmount();
            loginInput.value = '';
            passwordInput.value = '';
        };

        const populateDateFilters = () => {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            summaryMonthEl.innerHTML = `<option value="all">All Time</option>`;
            months.forEach((month, index) => { summaryMonthEl.innerHTML += `<option value="${index}">${month}</option>`; });
            summaryYearEl.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) { summaryYearEl.innerHTML += `<option value="${i}">${i}</option>`; }
            summaryMonthEl.value = currentMonth;
            summaryYearEl.value = currentYear;
        };

        async function main() {
            const firebaseConfig = {
                apiKey: "AIzaSyD2rTmmE1S7r3HWEBfPyCy4z3bm0laf_zY",
                authDomain: "media-26-iptv-web-app.firebaseapp.com",
                projectId: "media-26-iptv-web-app",
                storageBucket: "media-26-iptv-web-app.appspot.com",
                messagingSenderId: "275790205517",
                appId: "1:275790205517:web:c93d045a9c3a5ce0ef0204",
                measurementId: "G-6LEHEKFCBV"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setupEventListeners(); 
            userId = "gL1KLYx6NqdokNaHoY3zhUvoRPo1";
            loadData(userId);
            populateDateFilters();
            initializeFormDefaults();
        }

        const checkDelayedPayments = () => {
            const today = new Date();
            const twoDaysAgo = new Date();
            twoDaysAgo.setDate(today.getDate() - 2);

            const delayedCustomers = localCustomers.filter(customer => {
                const subDate = new Date(customer.subDate);
                return customer.status === 'Unpaid' && subDate < twoDaysAgo;
            });

            if (delayedCustomers.length > 0) {
                notificationBar.textContent = `You have ${delayedCustomers.length} customer(s) with delayed payments.`;
                notificationBar.style.display = 'block';
                delayedList.innerHTML = '';
                delayedCustomers.forEach(customer => {
                    const li = document.createElement('li');
                    li.textContent = `${customer.name} - Payment due since ${formatDisplayDate(customer.subDate)}`;
                    delayedList.appendChild(li);
                });
                delayedPaymentModal.style.display = 'flex';
            } else {
                notificationBar.style.display = 'none';
                delayedPaymentModal.style.display = 'none';
            }
        };

        function loadData(uid) {
            if (!uid) { return; }
            const customerCol = collection(db, `users/${uid}/customers`);
            onSnapshot(customerCol, (snapshot) => {
                localCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
                updateSummary();
                checkDelayedPayments();
            });
            const expenseCol = collection(db, `users/${uid}/expenses`);
            onSnapshot(expenseCol, (snapshot) => {
                localExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpensesTable();
                updateSummary();
            });
        }
        
        const updateUndoButton = () => {
            if (lastAction) {
                undoBtn.disabled = false;
                undoBtn.textContent = `Undo ${lastAction.action}`;
            } else {
                undoBtn.disabled = true;
                undoBtn.textContent = 'Undo Last Action';
            }
        };
        
        const generateMonthOptions = (selectedType) => {
            let options = '';
            for (let i = 1; i <= 12; i++) {
                options += `<option value="${i}" ${selectedType == i ? 'selected' : ''}>${i} Month${i > 1 ? 's' : ''}</option>`;
            }
            options += `<option value="trial" ${selectedType == 'trial' ? 'selected' : ''}>Trial</option>`;
            return options;
        };

        const renderRow_ViewMode = (customer) => {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const endDate = new Date(customer.endDate);
            const dayDiff = Math.ceil((endDate - today) / (1000 * 3600 * 24));
            const statusIcon = customer.status === 'Paid'
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--danger-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
            return `
                <td><span class="view-span">${customer.name || ''}</span></td>
                <td><span class="view-span">${customer.phone || ''}</span></td>
                <td><span class="view-span">${customer.login || ''}</span></td>
                <td><span class="view-span">${formatDisplayDate(customer.subDate)}</span></td>
                <td><span class="view-span">${formatDisplayDate(customer.endDate)}</span></td>
                <td><span class="view-span">${dayDiff < 0 ? 'Expired' : dayDiff}</span></td>
                <td style="text-align: center;"><span class="view-span">${statusIcon}</span></td>
                <td><span class="view-span">${customer.note || ''}</span></td>
                <td><div class="actions-cell"><button class="btn btn-edit">Edit</button><button class="btn btn-delete">Delete</button></div></td>`;
        };
        const renderRow_EditMode = (customer) => {
            return `
                <td><input type="text" data-prop="name" value="${customer.name || ''}"></td>
                <td><input type="tel" data-prop="phone" value="${customer.phone || ''}"></td>
                <td><input type="text" data-prop="login" value="${customer.login || ''}"></td>
                <td><input type="date" data-prop="subDate" value="${formatDate(customer.subDate)}"></td>
                <td><input type="text" data-prop="endDate" value="${formatDisplayDate(customer.endDate)}" readonly></td>
                <td><select data-prop="subscriptionType">${generateMonthOptions(customer.subscriptionType)}</select></td>
                <td><select data-prop="status"><option value="Paid" ${customer.status === 'Paid' ? 'selected' : ''}>Paid</option><option value="Unpaid" ${customer.status === 'Unpaid' ? 'selected' : ''}>Unpaid</option></select></td>
                <td><input type="text" data-prop="note" value="${customer.note || ''}"></td>
                <td><div class="actions-cell"><button class="btn btn-save">Save</button><button class="btn btn-delete">Delete</button></div></td>`;
        };
        
        const renderTable = () => { 
            const searchTerm = searchInput.value.toLowerCase(); 
            let customersToRender = [...localCustomers]; 
            if (searchTerm) { customersToRender = customersToRender.filter(c => (c.name || '').toLowerCase().includes(searchTerm) || (c.login || '').toLowerCase().includes(searchTerm)); }
            customersToRender.sort((a, b) => { const key = sortConfig.key; const direction = sortConfig.direction === 'asc' ? 1 : -1; let valA, valB; if (key === 'daysLeft') { const today = new Date(); today.setHours(0,0,0,0); valA = Math.ceil((new Date(a.endDate) - today) / (1000 * 3600 * 24)); valB = Math.ceil((new Date(b.endDate) - today) / (1000 * 3600 * 24)); } else if (key === 'subDate' || key === 'endDate') { valA = new Date(a[key]); valB = new Date(b[key]); } else { valA = (a[key] || '').toLowerCase(); valB = (b[key] || '').toLowerCase(); } if (valA < valB) return -1 * direction; if (valA > valB) return 1 * direction; return 0; });
            customerTableBody.innerHTML = ''; 
            if (customersToRender.length === 0) { customerTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 40px;">No customers found.</td></tr>`; return; } 
            customersToRender.forEach((customer) => { 
                const row = document.createElement('tr'); 
                row.dataset.id = customer.id;
                const today = new Date(); today.setHours(0,0,0,0);
                const dayDiff = Math.ceil((new Date(customer.endDate) - today) / (1000 * 3600 * 24));
                if (dayDiff < 0) { row.classList.add('row-expired'); } else if (dayDiff < 5) { row.classList.add('row-expiring'); }
                row.innerHTML = renderRow_ViewMode(customer);
                customerTableBody.appendChild(row); 
            }); 
        };
        
        const renderExpensesTable = () => { 
            expenseTableBody.innerHTML = ''; if (localExpenses.length === 0) { expenseTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No expenses yet.</td></tr>`; return; } 
            const sortedExpenses = [...localExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedExpenses.forEach((expense) => { const row = document.createElement('tr'); row.dataset.id = expense.id; row.innerHTML = `<td>${expense.description}</td><td>${formatCurrency(expense.amount)}</td><td>${formatDisplayDate(expense.date)}</td><td><button class="btn btn-delete">Delete</button></td>`; expenseTableBody.appendChild(row); }); 
        };

        const updateSummary = () => { 
            const selectedMonth = summaryMonthEl.value; const selectedYear = summaryYearEl.value; 
            let customersForPeriod = localCustomers; let expensesForPeriod = localExpenses; 
            if (selectedMonth !== 'all') { 
                customersForPeriod = localCustomers.filter(c => { const subDate = new Date(c.subDate); return subDate.getFullYear() == selectedYear && subDate.getMonth() == selectedMonth; }); 
                expensesForPeriod = localExpenses.filter(e => { const expDate = new Date(e.date); return expDate.getFullYear() == selectedYear && expDate.getMonth() == selectedMonth; }); 
            } 
            const incomeThisMonth = customersForPeriod.filter(c => c.status === 'Paid').reduce((sum, c) => sum + (c.amount || 0), 0); 
            const expensesThisMonth = expensesForPeriod.reduce((sum, e) => sum + (e.amount || 0), 0); 
            const netProfitThisMonth = incomeThisMonth - expensesThisMonth;
            
            let activeCount = 0;
            let expiredCount = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            localCustomers.forEach(customer => {
                const endDate = new Date(customer.endDate);
                if (endDate < today) {
                    expiredCount++;
                } else {
                    activeCount++;
                }
            });

            activeUsersEl.textContent = activeCount;
            expiredUsersEl.textContent = expiredCount;
            customerCountEl.textContent = customersForPeriod.length; 
            totalIncomeEl.textContent = formatCurrency(incomeThisMonth); 
            totalExpensesEl.textContent = `-${formatCurrency(expensesThisMonth)}`; 
            netProfitEl.textContent = formatCurrency(netProfitThisMonth);
            netProfitEl.className = netProfitThisMonth >= 0 ? 'net-profit' : 'total-expenses';
        };
        
        function setupEventListeners() { 
            undoBtn.addEventListener('click', () => {
                if (!lastAction) return;
                if (lastAction.type === 'delete') {
                    setDoc(doc(db, `users/${userId}/customers`, lastAction.id), lastAction.data);
                }
                if (lastAction.type === 'edit') {
                    updateDoc(doc(db, `users/${userId}/customers`, lastAction.id), lastAction.data);
                }
                lastAction = null;
                updateUndoButton();
            });

            addExpenseBtn.addEventListener('click', () => {
                expenseModal.style.display = 'flex';
            });
            expenseModalCloseBtn.addEventListener('click', () => {
                expenseModal.style.display = 'none';
            });
            modalCloseBtn.addEventListener('click', () => {
                delayedPaymentModal.style.display = 'none';
            });
            
            customerTableBody.addEventListener('change', (e) => {
                const row = e.target.closest('tr'); if (!row) return;
                const isStartDate = e.target.dataset.prop === 'subDate';
                const isSubType = e.target.dataset.prop === 'subscriptionType';
                if (isStartDate || isSubType) {
                    const startDateInput = row.querySelector('[data-prop="subDate"]');
                    const subTypeInput = row.querySelector('[data-prop="subscriptionType"]');
                    const endDateInput = row.querySelector('[data-prop="endDate"]');
                    const newStartDate = new Date(startDateInput.value);
                    const subType = subTypeInput.value;
                    if (!newStartDate.getTime()) return;
                    if (subType === 'trial') { newStartDate.setDate(newStartDate.getDate() + 7); } 
                    else { newStartDate.setMonth(newStartDate.getMonth() + parseInt(subType, 10)); }
                    endDateInput.value = formatDisplayDate(newStartDate);
                }
            });

            customerTableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr'); if (!row) return;
                const docId = row.dataset.id;
                const customer = localCustomers.find(c => c.id === docId);

                if (e.target.classList.contains('btn-edit')) {
                    row.innerHTML = renderRow_EditMode(customer);
                }

                if (e.target.classList.contains('btn-save')) {
                    const updatedData = {
                        name: row.querySelector('[data-prop="name"]').value,
                        phone: row.querySelector('[data-prop="phone"]').value,
                        login: row.querySelector('[data-prop="login"]').value,
                        status: row.querySelector('[data-prop="status"]').value, 
                        note: row.querySelector('[data-prop="note"]').value,
                        subDate: formatDate(row.querySelector('[data-prop="subDate"]').value),
                        subscriptionType: row.querySelector('[data-prop="subscriptionType"]').value,
                        endDate: formatDate(row.querySelector('[data-prop="endDate"]').value)
                    };
                    lastAction = { type: 'edit', action: `edit on ${customer.name}`, id: docId, data: { ...customer } };
                    updateUndoButton();
                    updateDoc(doc(db, `users/${userId}/customers`, docId), updatedData);
                }
                
                if (e.target.classList.contains('btn-delete')) {
                    if (confirm('Are you sure you want to delete this customer?')) {
                        lastAction = { type: 'delete', action: `delete of ${customer.name}`, id: docId, data: { ...customer } };
                        updateUndoButton();
                        deleteDoc(doc(db, `users/${userId}/customers`, docId));
                    }
                }
            });

            expenseTableBody.addEventListener('click', (e) => {
                if (!e.target.classList.contains('btn-delete')) return;
                const row = e.target.closest('tr');
                const docId = row.dataset.id;
                if (confirm('Are you sure you want to delete this expense?')) {
                    deleteDoc(doc(db, `users/${userId}/expenses`, docId));
                }
            });
            
            document.getElementById('customer-table').querySelector('thead').addEventListener('click', (e) => { const header = e.target.closest('th.sortable'); if (!header) return; const key = header.dataset.sort; const direction = sortConfig.key === key && sortConfig.direction === 'asc' ? 'desc' : 'asc'; sortConfig = { key, direction }; document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sort-asc', 'sort-desc')); header.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc'); renderTable(); });
            
            expenseForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if (!userId) { return alert("Cannot add expense: User not signed in."); } 
                const amount = parseFloat(document.getElementById('expenseAmount').value); 
                if (isNaN(amount) || amount <= 0) { return alert("Please enter a valid expense amount."); } 
                const newExpense = { date: expenseDateInput.value, amount: amount, description: document.getElementById('expenseType').value }; 
                addDoc(collection(db, `users/${userId}/expenses`), newExpense).then(() => { 
                    expenseForm.reset(); 
                    initializeFormDefaults();
                    expenseModal.style.display = 'none';
                }).catch(error => console.error("Error adding expense:", error)); 
            });
            
            customerForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const submitButton = customerForm.querySelector('button[type="submit"]'); 
                if (!userId) { alert("Error: User ID is not set."); return; } 
                const customerName = customerNameInput.value.trim();
                
                const isDuplicate = localCustomers.some(c => c.name.toLowerCase() === customerName.toLowerCase());
                if (isDuplicate) {
                    alert("A customer with this name already exists.");
                    customerNameInput.classList.add('error');
                    setTimeout(() => customerNameInput.classList.remove('error'), 3000);
                    return;
                }

                if (!customerName) { alert("Please enter a customer name."); customerNameInput.focus(); return; } 
                try { 
                    const formData = new FormData(customerForm); 
                    const newCustomer = { 
                        name: customerName,
                        phone: formData.get('phone'),
                        login: loginInput.value, 
                        password: passwordInput.value, 
                        subDate: formData.get('subscriptionDate'), 
                        endDate: subscriptionEndingDate.value, 
                        status: formData.get('paymentStatus'), 
                        note: formData.get('specialNote'), 
                        amount: parseFloat(paymentAmountInput.value) || 0, 
                        subscriptionType: formData.get('subscriptionType') 
                    }; 
                    submitButton.disabled = true; 
                    submitButton.textContent = 'Adding...'; 
                    addDoc(collection(db, `users/${userId}/customers`), newCustomer).then(() => { 
                        alert('Customer added successfully!'); 
                        customerForm.reset(); 
                        initializeFormDefaults(); 
                    }).catch(error => { 
                        console.error("Error adding customer:", error); 
                        alert(`Error: ${error.message}`); 
                    }).finally(() => { 
                        submitButton.disabled = false; 
                        submitButton.textContent = 'Add New Customer'; 
                    }); 
                } catch (error) { 
                    console.error("Error creating customer:", error); 
                    alert(`Error: ${error.message}`); 
                    submitButton.disabled = false; 
                    submitButton.textContent = 'Add New Customer'; 
                } 
            });
            
            subscriptionType.addEventListener('change', updatePaymentAmount);
            customerNameInput.addEventListener('input', (e) => { const { login, password } = generateCredentials(e.target.value); loginInput.value = login; passwordInput.value = password; }); 
            subscriptionDate.addEventListener('change', calculateEndDate); 
            subscriptionType.addEventListener('change', calculateEndDate); 
            summaryMonthEl.addEventListener('change', updateSummary); 
            summaryYearEl.addEventListener('change', updateSummary); 
            searchInput.addEventListener('input', renderTable); 
        }

        populateDateFilters();
        main();
    </script>
</body>
</html>
```