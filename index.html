<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media26 IPTV Dashboard</title>
    <style>
        /* --- Professional Theme (Blue Accent) --- */
        :root {
            --bg-color: #f8f9fa;
            --card-color: #ffffff;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-color: #0d6efd; /* Professional Blue */
            --accent-hover: #0b5ed7;
            --danger-color: #dc3545;
            --danger-hover: #bb2d3b;
            --success-color: #198754;
            --warning-bg: #fff3cd;
            --expired-bg: #f8d7da;
            --font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
        }

        aside {
            width: 350px;
            flex-shrink: 0;
            background-color: #ffffff;
            padding: 30px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 30px;
            overflow-y: auto;
        }
        
        main {
            flex-grow: 1;
            padding: 30px 40px;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--text-primary);
            margin: 0;
            font-weight: 600;
        }
        
        h1 { font-size: 1.8em; margin-bottom: 30px; }
        h2 { font-size: 1.5em; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        h3 { font-size: 1.25em; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }

        .card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f5;
        }
        .summary-item:last-of-type { border-bottom: none; }
        .summary-item span:first-child { color: var(--text-secondary); font-size: 0.9em; }
        .summary-item span:last-child { font-weight: 600; font-size: 1.1em; }
        #netProfit.net-profit { color: var(--success-color); }
        #netProfit.total-expenses, #totalExpenses { color: var(--danger-color); }
        
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        label { font-weight: 500; font-size: 0.9em; color: var(--text-secondary); }
        
        input, select, textarea {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
        }
        input[readonly] { background-color: #e9ecef; }

        .btn {
            padding: 8px 12px;
            border: 1px solid transparent;
            border-radius: 0.375rem;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary { background-color: var(--accent-color); color: #fff; width: 100%; grid-column: 1 / -1; margin-top: 10px; padding: 12px 20px; }
        .btn-primary:hover:not(:disabled) { background-color: var(--accent-hover); }

        .actions-cell { display: flex; gap: 8px; }
        .btn-edit { background-color: #cfe2ff; color: #0a58ca; }
        .btn-edit:hover { background-color: #b9d3fa; }
        .btn-save { background-color: #d1e7dd; color: var(--success-color); }
        .btn-save:hover { background-color: #badbcc; }
        
        .table-container { 
            width: 100%; 
            overflow-x: auto; 
            border: 1px solid var(--border-color); 
            border-radius: 0.5rem; 
            background-color: #fff;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th, td {
            padding: 12px 15px;
            font-size: 0.9em;
            vertical-align: middle;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        th:last-child, td:last-child {
            border-right: none;
        }
        tbody tr:last-child > td { border-bottom: none; }
        
        thead th {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
        }
        
        tbody tr:hover { background-color: #f8f9fa; }
        
        tbody .view-mode input, tbody .view-mode select { display: none; }
        tbody .edit-mode .view-span { display: none; }

        .row-expiring { background-color: var(--warning-bg) !important; }
        .row-expired { background-color: var(--expired-bg) !important; }
        
        .btn-delete { 
            background-color: #f8d7da;
            color: var(--danger-color);
        }
        .btn-delete:hover { 
            background-color: var(--danger-color);
            color: #fff;
        }
    </style>
</head>
<body>

    <div class="container">
        <aside>
            <div class="card">
                <h3>Summary Report</h3>
                <div class="summary-filter"><select id="summaryMonth"></select><select id="summaryYear"></select></div>
                <div class="summary-item"><span>Customers This Month</span><span id="customerCount">0</span></div>
                <div class="summary-item"><span>Income This Month</span><span id="totalIncome">$0.00</span></div>
                <div class="summary-item"><span>Expenses This Month</span><span id="totalExpenses">-$0.00</span></div>
                <div class="summary-item"><span>Net Profit This Month</span><span id="netProfit">$0.00</span></div>
            </div>
            <div class="card">
                <h3>Add Expense</h3>
                <form id="expenseForm" class="form-group">
                    <label for="expenseType">Purchasing Credits</label><select id="expenseType" name="expenseType" required><option>Smart4k</option><option>Magic</option></select>
                    <label for="expenseAmount">Amount ($)</label><input type="number" id="expenseAmount" name="expenseAmount" min="0" step="0.01" required>
                    <label for="expenseDate">Expense Date</label><input type="date" id="expenseDate" name="expenseDate" required>
                    <button type="submit" class="btn" style="padding: 12px 20px; margin-top: 10px; background-color: var(--success-color); color: #fff;">Add Expense</button>
                </form>
            </div>
            <div class="card">
                <h3>Expense List</h3>
                <div class="table-container" style="max-height: 280px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>Description</th><th>Amount</th><th>Date</th><th>Actions</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>
        </aside>

        <main>
            <h1>IPTV Dashboard</h1>
            <div class="card">
                <h2>Create New Customer</h2>
                <form id="newCustomerForm">
                    <div class="form-grid">
                        <div class="form-group"><label for="customerName">Customer Name</label><input type="text" id="customerName" name="customerName" required></div>
                        <div class="form-group"><label for="login">Login</label><input type="text" id="login" name="login" readonly></div>
                        <div class="form-group"><label for="password">Password</label><input type="text" id="password" name="password" readonly></div>
                        <div class="form-group"><label for="macAddress">MAC Address (Optional)</label><input type="text" id="macAddress" name="macAddress"></div>
                        <div class="form-group"><label for="subscriptionType">Subscription</label><select id="subscriptionType" name="subscriptionType" required><option value="6">6 Months</option><option value="1">1 Month</option><option value="3">3 Months</option><option value="12">12 Months</option><option value="trial">Trial (7 days)</option></select></div>
                        <div class="form-group"><label for="subscriptionDate">Subscription Date</label><input type="date" id="subscriptionDate" name="subscriptionDate" required></div>
                        <div class="form-group"><label for="subscriptionEndingDate">Subscription Ending Date</label><input type="text" id="subscriptionEndingDate" name="subscriptionEndingDate" readonly></div>
                        <div class="form-group"><label for="paymentStatus">Payment Status</label><select id="paymentStatus" name="paymentStatus" required><option>Paid</option><option>Unpaid</option></select></div>
                        <div class="form-group"><label for="paymentAmount">Payment Amount ($)</label><input type="number" id="paymentAmount" name="paymentAmount" min="0" step="0.01" required></div>
                        <div class="form-group full-width"><label for="specialNote">Special Note</label><textarea id="specialNote" name="specialNote"></textarea></div>
                        <button type="submit" class="btn btn-primary">Add New Customer</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>Customer List</h2>
                <div class="search-bar" style="margin-bottom: 20px;"><input type="text" id="searchInput" placeholder="Search by name or login..."></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Customer Name</th><th>Login</th><th>Created On</th><th>Ends On</th><th>Days Left</th><th>Status</th><th>Note</th><th>Actions</th></tr></thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const customerForm = document.getElementById('newCustomerForm');
        const expenseForm = document.getElementById('expenseForm');
        const customerNameInput = document.getElementById('customerName');
        const loginInput = document.getElementById('login');
        const passwordInput = document.getElementById('password');
        const customerTableBody = document.getElementById('customerTableBody');
        const expenseTableBody = document.getElementById('expenseTableBody');
        const subscriptionType = document.getElementById('subscriptionType');
        const subscriptionDate = document.getElementById('subscriptionDate');
        const subscriptionEndingDate = document.getElementById('subscriptionEndingDate');
        const expenseDateInput = document.getElementById('expenseDate');
        const paymentAmountInput = document.getElementById('paymentAmount');
        const customerCountEl = document.getElementById('customerCount');
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netProfitEl = document.getElementById('netProfit');
        const summaryMonthEl = document.getElementById('summaryMonth');
        const summaryYearEl = document.getElementById('summaryYear');
        const searchInput = document.getElementById('searchInput');
        
        let localCustomers = [];
        let localExpenses = [];
        let userId = null;
        let db; 

        async function main() {
            const firebaseConfig = {
                apiKey: "AIzaSyD2rTmmE1S7r3HWEBfPyCy4z3bm0laf_zY",
                authDomain: "media-26-iptv-web-app.firebaseapp.com",
                projectId: "media-26-iptv-web-app",
                storageBucket: "media-26-iptv-web-app.appspot.com",
                messagingSenderId: "275790205517",
                appId: "1:275790205517:web:c93d045a9c3a5ce0ef0204",
                measurementId: "G-6LEHEKFCBV"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setupEventListeners(); 
            userId = "gL1KLYx6NqdokNaHoY3zhUvoRPo1";
            loadData(userId);
        }

        function loadData(uid) {
            if (!uid) { return; }
            const customerCol = collection(db, `users/${uid}/customers`);
            onSnapshot(customerCol, (snapshot) => {
                localCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTable();
                updateSummary();
            });
            const expenseCol = collection(db, `users/${uid}/expenses`);
            onSnapshot(expenseCol, (snapshot) => {
                localExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExpensesTable();
                updateSummary();
            });
        }
        
        const updatePaymentAmount = () => {
            const subscriptionValue = subscriptionType.value;
            let amount = 0;
            if (subscriptionValue === 'trial') {
                amount = 0;
            } else {
                const months = parseInt(subscriptionValue, 10);
                amount = months * 10;
            }
            paymentAmountInput.value = amount.toFixed(2);
        };

        const renderRow_ViewMode = (customer) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(customer.endDate);
            const dayDiff = Math.ceil((endDate - today) / (1000 * 3600 * 24));

            const statusIcon = customer.status === 'Paid'
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--danger-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;

            return `
                <td><span class="view-span">${customer.name || ''}</span></td>
                <td><span class="view-span">${customer.login || ''}</span></td>
                <td><span class="view-span">${formatDisplayDate(customer.subDate)}</span></td>
                <td><span class="view-span">${formatDisplayDate(customer.endDate)}</span></td>
                <td><span class="view-span">${dayDiff < 0 ? 'Expired' : dayDiff}</span></td>
                <td style="text-align: center;"><span class="view-span">${statusIcon}</span></td>
                <td><span class="view-span">${customer.note || ''}</span></td>
                <td>
                    <div class="actions-cell">
                        <button class="btn btn-edit">Edit</button>
                        <button class="btn btn-delete">Delete</button>
                    </div>
                </td>
            `;
        };

        const renderRow_EditMode = (customer) => {
             const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(customer.endDate);
            const dayDiff = Math.ceil((endDate - today) / (1000 * 3600 * 24));
            
            return `
                <td><input type="text" data-prop="name" value="${customer.name || ''}"></td>
                <td><input type="text" data-prop="login" value="${customer.login || ''}"></td>
                <td>${formatDisplayDate(customer.subDate)}</td>
                <td>${formatDisplayDate(customer.endDate)}</td>
                <td>${dayDiff < 0 ? 'Expired' : dayDiff}</td>
                <td><select data-prop="status"><option value="Paid" ${customer.status === 'Paid' ? 'selected' : ''}>Paid</option><option value="Unpaid" ${customer.status === 'Unpaid' ? 'selected' : ''}>Unpaid</option></select></td>
                <td><input type="text" data-prop="note" value="${customer.note || ''}"></td>
                <td>
                    <div class="actions-cell">
                        <button class="btn btn-save">Save</button>
                        <button class="btn btn-delete">Delete</button>
                    </div>
                </td>
            `;
        };
        
        const renderTable = () => { 
            const searchTerm = searchInput.value.toLowerCase(); 
            let customersToRender = [...localCustomers]; 
            if (searchTerm) { 
                customersToRender = customersToRender.filter(c => (c.name || '').toLowerCase().includes(searchTerm) || (c.login || '').toLowerCase().includes(searchTerm)); 
            } 
            customersToRender.sort((a, b) => new Date(b.subDate) - new Date(a.subDate)); 
            customerTableBody.innerHTML = ''; 
            if (customersToRender.length === 0) { 
                customerTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 40px;">No customers found.</td></tr>`; 
                return; 
            } 
            customersToRender.forEach((customer) => { 
                const row = document.createElement('tr'); 
                row.dataset.id = customer.id; 
                row.innerHTML = renderRow_ViewMode(customer);
                customerTableBody.appendChild(row); 
            }); 
        };
        
        function setupEventListeners() { 
            subscriptionType.addEventListener('change', updatePaymentAmount);
            customerForm.addEventListener('submit', (e) => { e.preventDefault(); /* ... */ });
            
            customerTableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;
                const docId = row.dataset.id;
                const customer = localCustomers.find(c => c.id === docId);

                // Handle Edit button click
                if (e.target.classList.contains('btn-edit')) {
                    row.innerHTML = renderRow_EditMode(customer);
                }

                // Handle Save button click
                if (e.target.classList.contains('btn-save')) {
                    const updatedData = {
                        name: row.querySelector('[data-prop="name"]').value,
                        login: row.querySelector('[data-prop="login"]').value,
                        status: row.querySelector('[data-prop="status"]').value,
                        note: row.querySelector('[data-prop="note"]').value,
                    };
                    updateDoc(doc(db, `users/${userId}/customers`, docId), updatedData)
                        .then(() => {
                           row.innerHTML = renderRow_ViewMode({...customer, ...updatedData});
                        })
                        .catch(err => console.error("Update failed:", err));
                }
                
                // Handle Delete button click
                if (e.target.classList.contains('btn-delete')) {
                    if (confirm('Are you sure you want to delete this customer?')) {
                        deleteDoc(doc(db, `users/${userId}/customers`, docId));
                    }
                }
            });

            // --- All other listeners remain below ---
            expenseForm.addEventListener('submit', (e) => { /* ... */ });
            customerNameInput.addEventListener('input', (e) => { const { login, password } = generateCredentials(e.target.value); loginInput.value = login; passwordInput.value = password; }); 
            subscriptionDate.addEventListener('change', calculateEndDate); 
            subscriptionType.addEventListener('change', calculateEndDate); 
            summaryMonthEl.addEventListener('change', updateSummary); 
            summaryYearEl.addEventListener('change', updateSummary); 
            searchInput.addEventListener('input', renderTable); 
        }

        // --- All other functions remain below ---
        function formatDate(dateString) { if (!dateString) return ''; const date = new Date(dateString); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; };
        function formatDisplayDate(dateString) { if (!dateString) return ''; const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; const date = new Date(dateString); date.setMinutes(date.getMinutes() + date.getTimezoneOffset()); const day = String(date.getDate()).padStart(2, '0'); const month = months[date.getMonth()]; const year = date.getFullYear(); return `${day}-${month}-${year}`; }
        const calculateEndDate = () => { const startDate = new Date(subscriptionDate.value); const type = subscriptionType.value; if (!startDate.getTime() || !subscriptionDate.value) return; if (type === 'trial') { startDate.setDate(startDate.getDate() + 7); } else { startDate.setMonth(startDate.getMonth() + parseInt(type, 10)); } subscriptionEndingDate.value = formatDate(startDate); };
        const formatCurrency = (amount) => (amount || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const generateCredentials = (fullName) => { if (!fullName) { return { login: '', password: '' }; } const names = fullName.trim().split(' ').filter(n => n); const firstName = (names[0] || '').toUpperCase(); const lastName = (names.length > 1 ? names[names.length - 1] : '').toUpperCase(); const login = 'M26' + firstName.substring(0, 3); let password = lastName ? 'M26' + firstName.substring(0, 2) + lastName.substring(0, 2) : 'M26' + firstName.substring(0, 2) + firstName.slice(-2); return { login, password }; };
        const updateSummary = () => { const selectedMonth = summaryMonthEl.value; const selectedYear = summaryYearEl.value; let customersForPeriod = localCustomers; let expensesForPeriod = localExpenses; if (selectedMonth !== 'all') { customersForPeriod = localCustomers.filter(c => { const subDate = new Date(c.subDate); return subDate.getFullYear() == selectedYear && subDate.getMonth() == selectedMonth; }); expensesForPeriod = localExpenses.filter(e => { const expDate = new Date(e.date); return expDate.getFullYear() == selectedYear && expDate.getMonth() == selectedMonth; }); } const incomeThisMonth = customersForPeriod.filter(c => c.status === 'Paid').reduce((sum, c) => sum + (c.amount || 0), 0); const expensesThisMonth = expensesForPeriod.reduce((sum, e) => sum + (e.amount || 0), 0); const netProfitThisMonth = incomeThisMonth - expensesThisMonth; customerCountEl.textContent = customersForPeriod.length; totalIncomeEl.textContent = formatCurrency(incomeThisMonth); totalExpensesEl.textContent = `-${formatCurrency(expensesThisMonth)}`; netProfitEl.textContent = formatCurrency(netProfitThisMonth); netProfitEl.classList.toggle('net-profit', netProfitThisMonth >= 0); netProfitEl.classList.toggle('total-expenses', netProfitThisMonth < 0); };
        const renderExpensesTable = () => { /* ... */ };
        const initializeFormDefaults = () => { const today = new Date(); subscriptionDate.value = formatDate(today); expenseDateInput.value = formatDate(today); calculateEndDate(); updatePaymentAmount(); loginInput.value = ''; passwordInput.value = ''; };
        const populateDateFilters = () => { const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; const currentYear = new Date().getFullYear(); const currentMonth = new Date().getMonth(); summaryMonthEl.innerHTML = `<option value="all">All Time</option>`; months.forEach((month, index) => { summaryMonthEl.innerHTML += `<option value="${index}">${month}</option>`; }); summaryYearEl.innerHTML = ''; for (let i = currentYear - 5; i <= currentYear + 5; i++) { summaryYearEl.innerHTML += `<option value="${i}">${i}</option>`; } summaryMonthEl.value = currentMonth; summaryYearEl.value = currentYear; };
        
        populateDateFilters();
        initializeFormDefaults();
        main();
    </script>
</body>
</html>
```